<?xml version="1.0"?>
<guide self="ebuild-writing/functions/src_test/">
<chapter>
<title>src_test</title>

<body>
<table>
  <tr>
    <th>Function</th>
    <ti><c>src_test</c></ti>
  </tr>
  <tr>
    <th>Purpose</th>
    <ti>Run pre-install test scripts</ti>
  </tr>
  <tr>
    <th>Sandbox</th>
    <ti>Enabled</ti>
  </tr>
  <tr>
    <th>Privilege</th>
    <ti>user</ti>
  </tr>
  <tr>
    <th>Called for</th>
    <ti>ebuild</ti>
  </tr>
</table>
</body>

<section>
<title>Default <c>src_test</c></title>
<body>
<p>The default test phase in EAPI 6 is equivalent to the following:</p>
<codesample lang="ebuild">
src_test() {
	if emake check -n &amp;> /dev/null; then
		emake check
	elif emake test -n &amp;> /dev/null; then
		emake test
	fi
}
</codesample>
</body>
</section>

<section>
<title>Sample <c>src_test</c></title>
<body>
<codesample lang="ebuild">
src_test() {
    cd "${S}"/src/testdir || die

    # Test 49 won't work inside a portage environment
    sed -i -e 's~test49.out~~g' Makefile || die

    # Try to run the non-gui tests only
    # pass -j1 if tests do not support being run in parallel
    emake -j1 test-nongui
}
</codesample>
</body>
</section>

<section>
<title>Common <c>src_test</c> Tasks</title>
<body>
<p>
Often the default <c>src_test</c> is fine. Sometimes it is necessary
to remove certain tests from the list if they cannot be used with a
portage environment. Reasons for such a failure could include:
</p>

<ul>
  <li>
    Needing to work with files which are disallowed by the sandbox.
  </li>
  <li>Requiring user input (src_test must not be interactive).</li>
  <li>Requiring root privileges.</li>
</ul>

<p>
Usually, removing the relevant test from the <c>Makefile</c>
using <c>sed</c> or skipping a particular <c>make</c> target is
sufficient.
</p>

<p>
Try to ensure that tests work properly for your ebuild. A good test
suite is extremely helpful for arch maintainers.
</p>

</body>
</section>

<section>
<title>Skipping Tests</title>
<body>
<p>
Sometimes it is necessary to skip tests entirely. This can be done by
setting <c>RESTRICT="test"</c> in the ebuild.
</p>

<note>
If upstream provide a test suite which doesn't work, consider talking
to them about getting it fixed. A broken test suite requires developers
to investigate each test failure in order to determine whether it is
genuine or indicates a broken test.
</note>
</body>
</section>

</chapter>
</guide>
